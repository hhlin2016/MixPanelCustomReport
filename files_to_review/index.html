<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
		<link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.1.0/chosen.min.css">
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.11/css/jquery.dataTables.css">
		<!-- smoothness library improves the appearance of the datepicker -->
		<link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
		<script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.1.0/chosen.jquery.min.js"></script>
		<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.js"></script>
		<script src="customQueryGenerator.js"></script>
		<script src="exportToCSV.js"></script>
		<script src="generalFunctionsAndVariables.js"></script>
		<script src="graphFunctions.js"></script>
	</head>
	<body class="mixpanel-platform-body">
		<div class="mixpanel-platform-section">
			<!-- Event Select -->
			<div id="labelSelectEvent" class="mixpanel-platform-label" 
				style="width: 258px; padding: 10 px">Select Event</div>
			<div id="eventSelect" style="float: left;"></div>
			
			<!-- Select Operating System -->
			<div style="clear: both;"></div>
			<div id="labelSelectPlatforms" class="mixpanel-platform-label" 
				style="width: 258px; padding: 10 px">Select Platform(s)</div>
			<select data-placeholder="Select Platform(s), leave empty for all" 
				class="chosen-platform" multiple="true" style="width: calc(100% - 300px); float:right" ></select>
			
			<!-- Select App Name(s) -->
			<div style="clear: both;"></div>
			<div id="labelSelectAppNames" class="mixpanel-platform-label" style=
				"width: 258px; padding: 10 px">Select Application(s)</div>
			<select data-placeholder="Select App(s), leave empty for all" class=
				"chosen-appName" multiple="true" style="width: calc(100% - 300px); float:right">
				</select>
				
			<!-- Select Device Models -->
			<div style="clear: both;"></div>
			<div id="labelSelectDeviceModels" class="mixpanel-platform-label" 
				style="width: 258px; padding: 10 px">Select Device Model(s)</div>
			<select data-placeholder="Select Model(s), leave empty for all" class=
				"chosen-model" multiple="true" style="width: calc(100% - 
				300px); float:right" ></select>
			<div style="clear: both;"></div>
			
			<!-- Select Number of Devices to be Shown -->
			<div id="labelNumDevices" class="mixpanel-platform-label" style="width: 
				258px; padding: 10 px">Show Number of Devices</div>
			<div id="numResultsSelect" style="float: left;"></div>
			
			<div style="padding:10px; float: left; width: 175px;"><input 
				style="display: none;" type="text" class = "tbxNumSelect" 
				id="tbxNumResultsSelect" placeholder="Enter # of Device
				Model(s)"></input></div>
			<button style= "display: none; float:left; padding: 5px;" class
				= "tbxNumSelect" id="btnNumDevicesSubmit">Submit</button> 
			
			<!-- Select Dates -->
			<div style="clear: both;"></div>
			<div id="labelSelectDates" class="mixpanel-platform-label" style=
				"width: 258px; padding: 10 px">Select Time Period</div>
			<div id="timeSelect" style="float: left;" placeholder = "Select a 
				time period"></div>
			<div id="labelFrom" class = "timeSelectGroup" style="display: 
				none; float: left; padding: 10px; ">From:</div>
			<input type="text" id="from" class = "timeSelectGroup" name="from" 
				style="width: 80px; float: left; display: none;" placeholder=
				"Start date:">
			<div id="labelTo" class = "timeSelectGroup" style="display: none; 
				float: left; padding: 10px;">To:</div>
			<input type="text" id="to" class = "timeSelectGroup" name="to" 
				style="width: 80px; float: left; display: none;" placeholder=
				"End date:">
			<div style="clear: both;"></div>
		</div>
		
		<!-- Graph -->
		<div id="graph"></div>
		<div style="clear: both;"></div><br>
		
		<!-- Table -->
		<table id = "dataTable"></table>
		
		<!-- DOWNLOAD BUTTON -->
		<div style="clear: both;"></div><br>
		<button onclick="exportToCSV()" style="float: right;">Download CSV</button>
		
		<script>			
			initializeChosenInterface();				
			initializeDropdownMenus();
			
			// Function to pull data and plot it
			// Called in Response to User Clicking On: dropdownDates, datePicker, 
			//		appName dropdown, eventSelect, Platform dropdown
			function runQuery(){
				var eventName = eventSelect.MPEventSelect('value');
				if (eventName) {
					// Parameters for custom query
					var params = {
						from_date: propertiesList.from,
						to_date: propertiesList.to,
						event: eventSelect.MPEventSelect('value')
					};
					// Build script
					var script = buildCustomQueryFunctionScript('$model', 1);
//					console.log("runQuery", script, params);
					// Get device data
					MP.api.custom_query(script, params).done(function(results) {
						// store data for use in dropdown and limit functions
						lastDataPull = results[0];
						// Calculate total users and build sorted device list
						parseBaseData(results[0]);
						// Plot data
						createDataTable(results[0]);
					});
					testQuery();
				}
			};
// TODO: TESTING ONLY, REMOVE
function testQuery(){
var eventName = eventSelect.MPEventSelect('value');
if (eventName) {
	// Parameters for custom query
	var params = {
		from_date: "2015-10-01",
		to_date: "2016-04-11",
		event: eventSelect.MPEventSelect('value')
	};
	// Build script
	var script = 'function main() {\
        return Events({\
          from_date: params.from_date,\
          to_date: params.to_date,\
          event_selectors: [{event: params.event}]\
        })\
        .filter(function(event) { return (event.name === params.event ) })\
        .groupByUser(["properties.App Name"],mixpanel.reducer.count())\
        .groupBy(["key.1"],mixpanel.reducer.count())\
       .reduce(function(previousData, object){\
					var allData = [];\
					var total = 0;\
					for (var i = 0; i < previousData.length;i++){\
						var elementPreviousData = previousData[i];\
						for (var j = 0; j < elementPreviousData.length;j++){\
							allData.push(elementPreviousData[j]);\
						}\
					}\
					for (i=0; i<object.length; i++){\
						var element = object[i].value.toString() + "    " +object[i].key["0"] ;\
						if (element){\
						  allData.push(element);\
						}\
						else{\
						  allData.push("undefined");\
						}\
					}\
					return allData;\
				})\
}';
//	console.log("testQuery", script, params);
	// Get device data
	MP.api.custom_query(script, params).done(function(results) {
		console.log("testQuery results", results)
	});
}
}
// END TESTING

			// Function to set default variables (Event === 'App Started'), 
			//		note time delay may need to be increased if it fails to 
			//		load appropriately
			function setDefaultEvent(){
				setTimeout(function() {
					$('#eventSelect').val('App Started');
				}, 2000);
			}
			setDefaultEvent();

			/*
			ON CHANGE effects
			*/
			dropdownLimit.on('change', function(e, selection) { 
				var selectedDeviceModels = $('.chosen-model').chosen().val()
				console.log("Change Limit", selection);
				customNumberDevicesSelect(selection);
				updateDataTablesSearchResults(selectedDeviceModels);
			});
			
			eventSelect.on('change', function(e, eventName) {
				console.log("Event change", eventName);
				clearDropdownMenu(dropdownVariables['platform']);
				clearDropdownMenu(dropdownVariables['appName']);
				clearDropdownMenu(dropdownVariables['model']);
				updateDropdownMenuData(dropdownVariables['platform']);
				updateDropdownMenuData(dropdownVariables['appName']);
				updateDropdownMenuData(dropdownVariables['model']);
				runQuery();
			});
			$( ".chosen-platform" ).change(function() {
				var selectedPlatforms = $('.chosen-platform').chosen().val()
				console.log("Change Platform", selectedPlatforms);
				clearDropdownMenu(dropdownVariables['appName']);
				clearDropdownMenu(dropdownVariables['model']);
				updateFilterString(dropdownVariables['platform']);
				updateDropdownMenuData(dropdownVariables['appName']);
				updateDropdownMenuData(dropdownVariables['model']);
				runQuery();
			});
			$( ".chosen-appName" ).change(function() {
				var selectedAppNames = $('.chosen-appName').chosen().val()
				console.log("Change appName", selectedAppNames);;
				clearDropdownMenu(dropdownVariables['model']);
				updateFilterString(dropdownVariables['appName']);
				updateDropdownMenuData(dropdownVariables['model']);
				runQuery();
			});
			$( ".chosen-model" ).change(function() {
				var selectedDeviceModels = $('.chosen-model').chosen().val()
				console.log("Change model", selectedDeviceModels);
				updateFilterString(dropdownVariables['model']);
				updateDataTablesSearchResults(selectedDeviceModels);
				plotGraph(lastDataPull);
			});
			dropdownDates.on('change', function(e, selection){
				updateTime(selection);
				clearDropdownMenu(dropdownVariables['platform']);
				clearDropdownMenu(dropdownVariables['appName']);
				clearDropdownMenu(dropdownVariables['model']);
				updateDropdownMenuData(dropdownVariables['platform']);
				updateDropdownMenuData(dropdownVariables['appName']);
				updateDropdownMenuData(dropdownVariables['model']);
				
				runQuery();
			});
			// Date picker, action on close
			$(function() {
				$( "#from" ).datepicker({
					dateFormat: "yy-mm-dd",
					defaultDate: "-1m",
					changeMonth: true,
					numberOfMonths: 2,
					maxDate: propertiesList["to"],
					onClose: function( selectedDate ) {
						// prevent users from selecting dates past the 'to' date
						$( "#to" ).datepicker( "option", "minDate", selectedDate );
						propertiesList["from"] = selectedDate;
						clearDropdownMenu(dropdownVariables['platform']);
						clearDropdownMenu(dropdownVariables['appName']);
						clearDropdownMenu(dropdownVariables['model']);
						updateDropdownMenuData(dropdownVariables['platform']);
						updateDropdownMenuData(dropdownVariables['appName']);
						updateDropdownMenuData(dropdownVariables['model']);
						runQuery();
					}
				});
				
				$( "#to" ).datepicker({
					dateFormat: "yy-mm-dd",
					defaultDate: "-0d",
					changeMonth: true,
					numberOfMonths: 2,
					maxDate: new Date(),
					onClose: function( selectedDate ) {
						// prevent users from selecting dates before the 'from' date
						$( "#from" ).datepicker( "option", "maxDate", selectedDate );
						propertiesList["to"] = selectedDate;
						clearDropdownMenu(dropdownVariables['platform']);
						clearDropdownMenu(dropdownVariables['appName']);
						clearDropdownMenu(dropdownVariables['model']);
						updateDropdownMenuData(dropdownVariables['platform']);
						updateDropdownMenuData(dropdownVariables['appName']);
						updateDropdownMenuData(dropdownVariables['model']);
						runQuery();
					}
				});
			});
			// Limit Device Textbox
			$("#btnNumDevicesSubmit").click(function () {	
				var textboxValue = tbxNumResultsSelect.value
				propertiesList['limit'] = textboxValue;
				createDataTable(lastDataPull);		
			});
		</script>
	</body>
</html>
