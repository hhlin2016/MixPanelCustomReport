<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
		<link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.1.0/chosen.min.css">
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.11/css/jquery.dataTables.css">
		<!-- smoothness library improves the appearance of the datepicker -->
		<link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
		<script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.1.0/chosen.jquery.min.js"></script>
		<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.js"></script>
	</head>
	<body class="mixpanel-platform-body">
		<div class="mixpanel-platform-section">
			<!-- Event Select -->
			<div id="labelSelectEvent" class="mixpanel-platform-label" style="width: 
				258px; padding: 10 px">Select Event</div>
			<div id="eventSelect" style="float: left;"></div>
			
			<!-- Select Operating System -->
			<div style="clear: both;"></div>
			<div id="labelSelectPlatforms" class="mixpanel-platform-label" style=
				"width: 258px; padding: 10 px">Select Platform(s)</div>
			<select data-placeholder="Select Platform(s), leave empty for all" class=
				"chosen-platform" multiple="true" style="width: calc(100% - 300px); float:right" ></select>
			
			<!-- Select App Name(s) -->
			<div style="clear: both;"></div>
			<div id="labelSelectAppNames" class="mixpanel-platform-label" style=
				"width: 258px; padding: 10 px">Select Application(s)</div>
			<select data-placeholder="Select App(s), leave empty for all" class=
				"chosen-appName" multiple="true" style="width: calc(100% - 300px); float:right" ></select>
			<!-- Select Device Models -->
			<div style="clear: both;"></div>
			<div id="labelSelectDeviceModels" class="mixpanel-platform-label" 
				style="width: 258px; padding: 10 px">Select Device Model(s)</div>
			<select data-placeholder="Select Model(s), leave empty for all" class=
				"chosen-model" multiple="true" style="width: calc(100% - 300px); float:right" ></select>
			<div style="clear: both;"></div>
			<!-- Select Number of Devices to be Shown -->
			<div id="labelNumDevices" class="mixpanel-platform-label" style="width: 
				258px; padding: 10 px">Show Number of Devices</div>
			<div id="numResultsSelect" style="float: left;"></div>
			
			<div style="padding:10px; float: left; width: 175px;"><input style="display: none;" type="text" class = "tbxNumSelect" id="tbxNumResultsSelect" placeholder="Enter # of Device Model(s)"></input></div>
			<button style= "display: none; float:left; padding: 5px;" class = "tbxNumSelect" id="btnNumDevicesSubmit">Submit</button> 
			
			<!-- Select Dates -->
			<div style="clear: both;"></div>
			<div id="labelSelectDates" class="mixpanel-platform-label" style="width: 
				258px; padding: 10 px">Select Time Period</div>
			<div id="timeSelect" style="float: left;" placeholder = "Select a time 
				period"></div>
			<div id="labelFrom" class = "timeSelectGroup" style="display: none; float: left; padding: 10px; ">
				From:</div>
			<input type="text" id="from" class = "timeSelectGroup" name="from" style="width: 80px; float: 
				left; display: none;" placeholder="Start date:">
			<div id="labelTo" class = "timeSelectGroup" style="display: none; float: left; padding: 10px;">
				To:</div>
			<input type="text" id="to" class = "timeSelectGroup" name="to" style="width: 80px; float: left; 
				display: none;" placeholder="End date:">
			<div style="clear: both;"></div>
		</div>
		<!-- Graph -->
		<div id="graph"></div>
		<div style="clear: both;"></div><br>
		<!-- Table -->
		<table id = "dataTable"></table>
		<!-- DOWNLOAD BUTTON -->
		<div style="clear: both;"></div><br>
		<button onclick="exportToCSV()" style="float: right;">Download CSV</button>
		<script>
			// Set initial properties required for segmentation
			var propertiesList = {
				appNameString : null,
				platformString : null,
				deviceModelString: null,
				from: moment().subtract(1, 'months').format("YYYY-MM-DD"),
				to: moment().format("YYYY-MM-DD"),
				limit : 10
			}
			var chosenNames = [
				{ chosenTitle : 'Platform', chosenID : '.chosen-platform', chosenStringName : "PlatformString"},
				{ chosenTitle : 'App Name', chosenID : '.chosen-appName', chosenStringName : "appNameString"},
				{ chosenTitle : '$model', chosenID : '.chosen-model', chosenStringName : "deviceModelString"}
			];
			// Initial variables
			var eventSelect = $('#eventSelect').MPEventSelect();
			var graphNumberLimit = 20; 	// Note: +1 in implementation for Totals column 
										// from Limit Field
			var eventGraph = $('#graph');
		
			// Initialize Chosen Interface
			$('.chosen-model').chosen().val();
			$('.chosen-platform').chosen().val();
			$('.chosen-appName').chosen().val();
			
			// Store data from last pull (for use with limit changes)
			var lastDataPull;
			// Global variables for referencing
			var deviceList;
			var totalNumUsers;
		  
			// Function to update the selected time from the dropdown menu
			// Also shows/hides elements relating to the jQuery datePicker
			// Inputs: 	Integer, period indicating months to go back (-1 denotes
			// 			custom time period)
			function updateTime(period) {
				if (period === -1){
					// Show datepicker and set time data
					$("#from").datepicker('setDate', propertiesList["from"]);
					$("#to").datepicker('setDate', propertiesList["to"]);
					$(".timeSelectGroup").show();
				}
				else {
					// Hide datepicker and set time data
					propertiesList["from"] = moment().subtract(parseInt(period), 
											'months').format("YYYY-MM-DD");
					propertiesList["to"] = moment().format("YYYY-MM-DD");
					$(".timeSelectGroup").hide();
				}
			}
			
			function customNumberDevicesSelect(numDevices) {
				if (numDevices === -1){
					// Show datepicker and set time data
					$(".tbxNumSelect").show();
				}
				else {
					// Hide datepicker and set time data
					propertiesList["limit"] = numDevices;
					$(".tbxNumSelect").hide();
					plotData(lastDataPull);
					//runQuery();
				}
			}
		  
			//Dropdown Limit Options
			var limitOptions = {
				items: [
					{label: '10', value: 10},
					{label: '20', value: 20},
					{label: '50', value: 50},
					{label: '100', value: 100},
					{label: '150', value: 150},
					{label: '200', value: 200},
					{label: '250', value: 250},
					{label: 'Select Custom Value: ', value: -1},
					{label: 'All', value: Infinity}
				]
			};
			
			// Dropdown Date Options
			var dateOptions = {
				items: [
					{label: '1 month', value: 1},
					{label: '3 months', value: 3},
					{label: '6 months', value: 6},
					{label: '12 months', value: 12},
					{label: 'Pick a Date Range', value: -1}
				]
			};

			// Instantiate dropdown menus
			var dropdownLimit = $('#numResultsSelect').MPSelect(limitOptions); // limit Options  
			var dropdownDates = $('#timeSelect').MPSelect(dateOptions);     // date Options
			
		
			function updateChosen(chosenName, data){
				$(chosenName.chosenID).chosen(); // Initialize chosen plugin searchbox
				if (data){
					for (var i = 0; i < data.length; i++){
						newKey = data[i];
						$(chosenName.chosenID).append("<option value='"+newKey+"'>"+newKey +"</option>");
						
					}
					// Update MUST be outside of loop otherwise will lag system incredibly 
					// with large input size
					$(chosenName.chosenID).trigger("chosen:updated");
				}
				else{
					alert("updateChosen, no data");
				}
				
			}
		  
			// Function to clear the Chosen Menu Options (essentially reset them),
			// 		propertiesList relevant String variable has to be cleared for new
			// 		custom_query call
			// Inputs: chosenID (i.e. '.chosen-appName')
			function clearChosen(chosenName){
				// Clear String property
				propertiesList[chosenName.chosenStringName] = null;
				// Clear chosen dropdown selectable values
				$(chosenName.chosenID).children().remove();
				// clear chosen dropdown selected values
				$(chosenName.chosenID).val('').trigger("chosen:updated");
			}
			
			function updateFilterString(chosenName){
				var itemList = $(chosenName.chosenID).chosen().val();
				if (itemList){
					var outputString = '(';
					var leftSideEquivalencyTest = 'event.properties["' + chosenName.chosenTitle + '"] === "';
					outputString += leftSideEquivalencyTest + itemList[0] + '"';
					for (var i = 1; i < itemList.length; i++){
						outputString += ' || ' + leftSideEquivalencyTest + itemList[i] + '"';
					}
					outputString += ')';
					propertiesList[chosenName.chosenStringName] = outputString;
				}
				else {
					propertiesList[chosenName.chosenStringName] = null;
				}
				
			}
					
			function getDropdownMenuData(chosenName){

				var params = {
					from_date: propertiesList.from,
					to_date: propertiesList.to,
					event: eventSelect.MPEventSelect('value')
				};
				MP.api.custom_query(stringBuilderChosenOptions(chosenName.chosenTitle, 0), params).done(function(results) {
					updateChosen(chosenName, results[0]);
					console.log("getDropdownMenuData", results[0])
				});		
			}
			
			// Selector == 0, retrieve menu data
			// Selector == 1, 
			// Selector == 2, retrieve table data
			
			function stringBuilderChosenOptions(propertySelector, selector){
				var startFunction = 'function main() { \
					return Events({from_date: params.from_date,\
						to_date: params.to_date,\
						event_selectors: [{event: params.event}]})';
				var eventFilter = '.filter(function(event) { return (event.name === params.event ) })';
				var propertyFilters = '';
				if (propertiesList.platformString){
					propertyFilters += '.filter(function(event) { return (' + propertiesList.platformString +' ) })';
				}
				if (propertiesList.appNameString){
					propertyFilters += '.filter(function(event) { return (' + propertiesList.appNameString +' ) })';
				}
				
				if (propertiesList.deviceModelString){
					propertyFilters += '.filter(function(event) { return (' + propertiesList.deviceModelString +' ) })';
				}
				var groupByString = '';
				var reducer = '';
				var map = '';
				switch (selector) {
					case 0:
						groupByString = '.groupBy(["properties.'+ propertySelector +'"], mixpanel.reducer.count())';
						
						reducer = 
							'.reduce(function(previousData, object){\
								var allData = [];\
								var total = 0;\
								for (var i = 0; i < previousData.length;i++){\
									var elementPreviousData = previousData[i];\
									for (var j = 0; j < elementPreviousData.length;j++){\
										allData.push(elementPreviousData[j]);\
									}\
								}\
								for (i=0; i<object.length; i++){\
									var element = object[i].key["0"];\
									allData.push(element);\
								}\
								return allData;\
							})'
						/*
						reducer = '.reduce(function(previousData, object){var outputData = [];\
						for (var i = 0; i < object.length; i++){\
							itemName = object[i].key["0"];\
						outputData.push(itemName);}return outputData;})'
						*/
						break;
					case 1:
						groupByString = '.groupByUser(["properties.$model"],mixpanel.reducer.count())\
							.groupBy(["key.1"], mixpanel.reducer.count())';
						
						reducer =
							'.reduce(function(previousData, object){\
								var allData = [];\
								var total = 0;\
								for (var i = 0; i < previousData.length;i++){\
									var elementPreviousData = previousData[i];\
									for (var j = 0; j < elementPreviousData.length;j++){\
										allData.push(elementPreviousData[j]);\
									}\
								}\
								for (i=0; i<object.length; i++){\
									var element = [object[i].key["0"], object[i].value];\
									allData.push(element);\
								}\
								return allData;\
							})'
						map = 
							'.map(function(event){\
								function sortByValue(a, b) {\
									if (a[1] === b[1]) {\
										return 0;\
									}\
									else {\
										return (a[1] < b[1]) ? 1 : -1;\
									}\
								}\
								var allData = [];\
								var total = 0;\
								event.sort(sortByValue);\
								for (var i = 0; i < event.length; i++){\
									total += event[i][1];\
								}\
								for (i = 0; i < event.length; i++){\
									var element = [i+1, event[i][0], event[i][1], parseFloat(event[i][1] / total * 100).toFixed(2)];\
									allData.push(element);\
								}\
								return allData;\
							})'
						
						/*
						reducer = '.reduce(function(previousData, object){\
							function sortByValue(a, b) {\
							if(a[1] === b[1]) {return 0;}\
							else {return (a[1] < b[1]) ? 1 : -1; }};\
							var partialData = [];var allData = [];var total = 0;\
							for (var i = 0; i < previousData.length;i++){\
								var elementPreviousData = previousData[i];\
								for (var j = 0; j < elementPreviousData.length;j++){\
									allData.push(elementPreviousData[j]);\
								}\
							}\
							for (i=0; i<object.length;i++){\
								total = total + object[i].value;\
								var element = [object[i].key["0"], object[i].value];\
								partialData.push(element);}\
							partialData.sort(sortByValue);\
							for (i=0; i<object.length; i++){\
								var newElement = [i+1, partialData[i][0], partialData[i][1], \
									parseFloat(partialData[i][1]/total*100).toFixed(2)];\
								allData.push(newElement);}\
							return allData;});';
						*/
						/*
						reducer ='.reduce(function(previousData, object){\
							var allKeys = [];\
							allKeys.push(object.length);\
							for (var i = 0; i < previousData.length; i++) {\
								allKeys.push(previousData[i]);\
							}\
							return allKeys;\
						});'
						*/
						break;
					default:
						alert("stringBuilderChosenOptions, incorrect selector value");
				}
				
				outputString = startFunction + eventFilter + propertyFilters + groupByString + reducer + map + '}';
				return outputString;
			
			}

			function runQuery(){
				var chosenID = ['.chosen-model', '.chosen-appName', '.chosen-platform'];
				
				var eventName = eventSelect.MPEventSelect('value');
				var initialParams = {from_date : propertiesList["from"], to_date : 
									propertiesList["to"]};
									

				if (eventName) {
					// Get custom query data
					// Parameters for custom query
					var params = {
						from_date: propertiesList.from,
						to_date: propertiesList.to,
						event: eventSelect.MPEventSelect('value')
					};
					
					MP.api.custom_query(stringBuilderChosenOptions('$model', 1), params).done(function(results) {
						
						lastDataPull = results[0];
						parseBaseData(results[0]);
						plotData(results[0]);
					});

				}
			};
			
			function convertArrayToJSON(data){
				outputData = {};
				var element;
				for (var i = 0; i < data.length; i++){
					element = data[i];
					outputData[element[1]] = element[2];
				}
				return outputData
			}
		  
			// Set default variables, note time delay may need to be increased if it fails 
			// to load appropriately
			function setDefaultEvent(){
				setTimeout(function() {
					$('#eventSelect').val('App Started');
				}, 2000);
			}
			setDefaultEvent();
			



			// DATATABLES IMPLEMENTATION
			// create dummy table for destruction (required for dataTablesChart function)
			var table = $('#instantlyDestroyedTable').DataTable(); 
			
			// Function to create dataTable using jQuery plug-in, dataTables
			// Inputs: dataSet, an object of Device : value pairings
			function plotData(dataSet){
				// Graph the data
				// Delete the old table
				if (eventGraph.length > 0) {
					eventGraph.remove();
				}
				// Create a new table
				eventGraph = $('<div id="#graph" />')
				$(".mixpanel-platform-section").after(eventGraph)
				// Select display type based on number of datapoints
				if (dataSet.length <= graphNumberLimit + 1){
					eventGraph.MPChart({chartType: 'pie'});
				}
				else {
					eventGraph.MPChart({chartType: 'bar'});
				}
				// Convert data back to acceptable form for MPChart
				var graphData = convertArrayToJSON(dataSet); 
//				eventGraph.MPChart('setData', graphData);

				// Generate dataTable Variables
				var titleArray = [{title : "Rank"},
					  {title : "Device Name"}, 
					  {title : "Number of Unique Users"},
					  {title : "Usage (%)"}];

				// Destroy the old table so it can be replaced with new data
				table.destroy();
				$('#dataTable').empty(); // empty in case the columns change
				var columnString = '<tfoot><tr><th></th><th></th><th></th><th> \
									</th></tr></tfoot>'; // For table footer below
				$("#dataTable").append(columnString);
				
				// Create a new table
				table = $('#dataTable').DataTable( {
				data: dataSet,
				columns: titleArray,
				"columnDefs": [
					{ className: "dt-center", "targets": [ 0 ] },
					{ className: "dt-center", "targets": [ 1 ] },
					{ className: "dt-center", "targets": [ 2 ] },
					{ className: "dt-center", "targets": [ 3 ] }
				],
				//"bFilter": false, // hide search box for table
//				'iDisplayLength': -1,
				//"lengthMenu": [ [10, 20, -1], [10, 20, "All"] ], // Number to display
				"iDisplayLength": propertiesList.limit, // Set to dropdown menu value
				"bLengthChange": false, // Hide dataTable option
				// Create Footer with sums
				"footerCallback": function ( row, data, start, end, display ) {
					var api = this.api(), data;

					// Remove the formatting to get integer data for summation
					var intVal = function ( i ) {
						return typeof i === 'string' ?
							i.replace(/[\$,]/g, '')*1 :
							typeof i === 'number' ?
								i : 0;
					};

					// Total number of users over all pages
					total = totalNumUsers;
					/*
					total = api
						.column( 2 )
						.data()
						.reduce( function (a, b) {
							return intVal(a) + intVal(b);
						} );
					*/
					totalNumDevices = deviceList.length;

					// Total number of users over this page
					pageTotal = api
						.column( 2, { page: 'current'} )
						.data()
						.reduce( function (a, b) {
							return intVal(a) + intVal(b);
						}, 0 );
					/*
					// Total percentage of users over this page
					pagePercentTotal = api
						.column( 3, { page: 'current'} )
						.data()
						.reduce( function (a, b) {
							return intVal(a) + intVal(b);
						}, 0 );
					*/

					// Update footer
					$( api.column( 2 ).footer() ).html(
						'Unique Users: ' + pageTotal +' / ' + total
					);
					pagePercentTotal = parseFloat((pageTotal/total)*100).toFixed(2);
					$( api.column( 3 ).footer() ).html(
						
						'Usage (%): ' + pagePercentTotal +' / 100.00'
					);

					// Label for device total in footer (static)
					$( api.column( 0 ).footer() ).html(
						'Total Number of Devices: ' + totalNumDevices
					);



					}

				});
			}

			// Provided by MixPanel staff with minor modifications to account
			// for Footer
			// Export to CSV function, don't need to edit unless CSV breaks
			function exportToCSV() {
				var csv = $("#dataTable").table2CSV({delivery:'string'});
				download(csv, "export.csv", "text/csv");
			}

			// Table2CSV
			jQuery.fn.table2CSV = function(options) {
				var options = jQuery.extend({
					separator: ',',
					header: [],
					delivery: 'popup' // popup, value
				},
				options);

				var csvData = [];
				var headerArr = [];
				var el = this;

				//header
				var numCols = options.header.length;
				var tmpRow = []; // construct header avalible array
//				var footerRow = [];

				if (numCols > 0) {
					for (var i = 0; i < numCols; i++) {
						tmpRow[tmpRow.length] = formatData(options.header[i]);
					}
				} else {
					$(el).filter(':visible').find('th').each(function() {
						if ($(this).css('display') != 'none') tmpRow[tmpRow.length] = formatData($(this).html());
					});
				}
				
//				footerRow = tmpRow.splice(0,4); // Remove footer data and move to end
				tmpRow.splice(0,4); // Remove footer data
				row2CSV(tmpRow);
				

				// actual data
				$(el).find('tr').each(function() {
					var tmpRow = [];
					$(this).filter(':visible').find('td').each(function() {
						if ($(this).css('display') != 'none') tmpRow[tmpRow.length] = formatData($(this).html());
					});
					row2CSV(tmpRow);
				});
//				row2CSV(footerRow);// Insert Footer Data 
				if (options.delivery == 'popup') {
					var mydata = csvData.join('\n');
					return popup(mydata);
				} else {
					var mydata = csvData.join('\n');
					return mydata;
				}
				

				function row2CSV(tmpRow) {
					var tmp = tmpRow.join('') // to remove any blank rows
					// alert(tmp);
					if (tmpRow.length > 0 && tmp != '') {
						var mystr = tmpRow.join(options.separator);
						csvData[csvData.length] = mystr;
					}
				}
				function formatData(input) {
					// replace " with â€œ
					var regexp = new RegExp(/["]/g);
					var output = input.replace(regexp, "â€œ");
					//HTML
					var regexp = new RegExp(/\<[^\<]+\>/g);
					var output = output.replace(regexp, "");
					if (output == "") return '';
					return '"' + output + '"';
				}
				function popup(data) {
					var generator = window.open('', 'csv', 'height=400,width=600');
					generator.document.write('<html><head><title>CSV</title>');
					generator.document.write('</head><body >');
					generator.document.write('<textArea cols=70 rows=15 wrap="off" >');
					generator.document.write(data);
					generator.document.write('</textArea>');
					generator.document.write('</body></html>');
					generator.document.close();
					return true;
				}
			};

			// Code to download the CSV
			function download(strData, strFileName, strMimeType) {
				var D = document,
				a = D.createElement("a");
				strMimeType= strMimeType || "application/octet-stream";


				if (navigator.msSaveBlob) { // IE10
					return navigator.msSaveBlob(new Blob([strData], {type: strMimeType}), strFileName);
				} /* end if(navigator.msSaveBlob) */


				if ('download' in a) { //html5 A[download]
					a.href = "data:" + strMimeType + "," + encodeURIComponent(strData);
					a.setAttribute("download", strFileName);
					a.innerHTML = "downloading...";
					D.body.appendChild(a);
					setTimeout(function() {
						a.click();
						D.body.removeChild(a);
					}, 66);
					return true;
				} /* end if('download' in a) */


				//do iframe dataURL download (old ch+FF):
				var f = D.createElement("iframe");
				D.body.appendChild(f);
				f.src = "data:" +  strMimeType   + "," + encodeURIComponent(strData);

				setTimeout(function() {
					D.body.removeChild(f);
				}, 333);
				return true;
			} /* end download() */

/*
TESTING
*/

function updateDataTablesSearch(data){
	// Since the search function doesn't work for names with spaces, search by index value
	if (data){
		// Find index of each device
		var indexValues = [];
		for (var i = 0; i < data.length; i++){
			// deviceList is assumed to be sorted based on # of users
			indexValues.push(($.inArray(data[i], deviceList) + 1).toString()); 
		}
		// Create search string
		
		var itemString = "^\\s*"+indexValues[0]+"\\s*$" ;		
		for (var i = 1; i < indexValues.length; i++){
			itemString += '|' + "^\\s*"+indexValues[i]+"\\s*$"  ;
		}
	
	// Search the table and draw the output
	table.column(0).search(itemString, true, false, true).draw();	
	console.log("updateDataTablesSearch", data, indexValues, deviceList);
	}
	// In event search criteria have been cleared, clear the table
	else{
	table
		.search( '' )
		.columns().search( '' )
		.draw();
	}
}


function parseBaseData(data){
	deviceList = [];
	totalNumUsers = 0;
	for (var i = 0; i < data.length;i++){
		deviceList.push(data[i][1]);
		totalNumUsers += data[i][2];
	}
}

/*
DONE TESTING
*/
			/*
			ON CHANGE effects
			*/
			dropdownLimit.on('change', function(e, selection) { 
				//propertiesList['limit'] = selection;
				
				customNumberDevicesSelect(selection);
				filterTable();
				// update data for model selection first
				//runQuery(); // runQuery run from customNumberDevicesSelect

			});
			
			eventSelect.on('change', function(e, eventName) {
				console.log("Event change", eventName);
				clearChosen(chosenNames[0]);
				clearChosen(chosenNames[1]);
				clearChosen(chosenNames[2]);
				getDropdownMenuData(chosenNames[0]);
				getDropdownMenuData(chosenNames[1]);
				getDropdownMenuData(chosenNames[2]);
				runQuery();
			});
			$( ".chosen-platform" ).change(function() {
				var selectedPlatforms = $('.chosen-platform').chosen().val()
				console.log("Change Platform", selectedPlatforms);
				clearChosen(chosenNames[1]);
				clearChosen(chosenNames[2]);
				updateFilterString(chosenNames[0]);
				getDropdownMenuData(chosenNames[1]);
				getDropdownMenuData(chosenNames[2]);
			});
			$( ".chosen-appName" ).change(function() {
				var selectedAppNames = $('.chosen-appName').chosen().val()
				console.log("Change appName", selectedAppNames);;
				clearChosen(chosenNames[2]);
				updateFilterString(chosenNames[1]);
				getDropdownMenuData(chosenNames[2]);
				//var appNameString = updatePropertyString(selectedAppNames, 'App Name');
				//propertiesList.property = appNameString;
				runQuery();
			});
			$( ".chosen-model" ).change(function() {
				var selectedDeviceModels = $('.chosen-model').chosen().val()
				console.log("Change model", selectedDeviceModels);
				updateFilterString(chosenNames[2]);
				updateDataTablesSearch(selectedDeviceModels);
				//var selectedDeviceModels = $('.chosen-model').chosen().val()
				//propertiesList['dropdownDeviceModelString'] = selectedDeviceModels;
				// Update for selected devices
				//adjustDataForSelectedDeviceModels();
				//runQuery();
			});
			dropdownDates.on('change', function(e, selection){
				// Possibility that selections may not be valid following period change
				// (i.e. from custom period to a set period, options may no longer be valid)
				
				clearChosen(chosenNames[0]);
				clearChosen(chosenNames[1]);
				clearChosen(chosenNames[2]);
				getDropdownMenuData(chosenNames[0]);
				getDropdownMenuData(chosenNames[1]);
				getDropdownMenuData(chosenNames[2]);
				updateTime(selection);
				runQuery();
			});
			// Date picker, action on close
			$(function() {
				$( "#from" ).datepicker({
					dateFormat: "yy-mm-dd",
					defaultDate: "-1m",
					changeMonth: true,
					numberOfMonths: 2,
					maxDate: propertiesList["to"],
					onClose: function( selectedDate ) {
						// prevent users from selecting dates past the 'to' date
						$( "#to" ).datepicker( "option", "minDate", selectedDate );
						propertiesList["from"] = selectedDate;
						// Since updating the to date could affect what platforms are available,
						// reset platform, app, and model selections
						clearChosen(chosenNames[0]);
						clearChosen(chosenNames[1]);
						clearChosen(chosenNames[2]);
						getDropdownMenuData(chosenNames[0]);
						getDropdownMenuData(chosenNames[1]);
						getDropdownMenuData(chosenNames[2]);
						//setChosenAppNames();
						runQuery();
					}
				});
				
				$( "#to" ).datepicker({
					dateFormat: "yy-mm-dd",
					defaultDate: "-0d",
					changeMonth: true,
					numberOfMonths: 2,
					maxDate: new Date(),
					onClose: function( selectedDate ) {
						// prevent users from selecting dates before the 'from' date
						$( "#from" ).datepicker( "option", "maxDate", selectedDate );
						propertiesList["to"] = selectedDate;
						// Since updating the from date could affect what platforms are available,
						// reset platform, app, and model selections
						clearChosen(chosenNames[0]);
						clearChosen(chosenNames[1]);
						clearChosen(chosenNames[2]);
						getDropdownMenuData(chosenNames[0]);
						getDropdownMenuData(chosenNames[1]);
						getDropdownMenuData(chosenNames[2]);

						//setChosenAppNames();
						runQuery();
					}
				});
			});
			// Limit Device Textbox
			$("#btnNumDevicesSubmit").click(function () {	
				//var userPass = document.getElementById('tbxNumResultsSelect');
				var textboxValue = tbxNumResultsSelect.value
				propertiesList['limit'] = textboxValue;
				plotData(lastDataPull);
				//runQuery();
				//alert(textboxValue);
				
			});
		</script>
	</body>
</html>
